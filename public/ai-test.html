<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 분석 종합 테스트</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 30px 0; 
            padding: 25px; 
            border: 2px solid #e9ecef; 
            border-radius: 12px; 
            background: #f8f9fa;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px;
            transition: all 0.3s ease;
        }
        button:hover { 
            background: #0056b3; 
            transform: translateY(-2px);
        }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed;
            transform: none;
        }
        input, select { 
            padding: 10px; 
            margin: 8px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px;
            width: 200px;
        }
        .image-preview {
            max-width: 300px;
            max-height: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        .result-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .badge {
            display: inline-block;
            padding: 8px 16px;
            margin: 5px;
            background: #ffc107;
            color: #212529;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge.earned {
            background: #28a745;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .btn-success {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🤖 AI 분석 종합 테스트</h1>
        <p class="info">AI 이미지 분석부터 포인트 저장, 이미지 표시, 뱃지 획득까지 전체 플로우를 테스트합니다.</p>
        
        <!-- 사용자 선택 -->
        <div class="test-section">
            <h2>👤 사용자 선택</h2>
            <input type="number" id="userId" placeholder="사용자 ID" value="1" min="1">
            <button onclick="loadUserData()">사용자 정보 로드</button>
            <div id="userInfo" class="result-box"></div>
        </div>

        <!-- AI 이미지 분석 테스트 -->
        <div class="test-section">
            <h2>📷 AI 이미지 분석 테스트</h2>
            <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)">
            <br>
            <img id="imagePreview" class="image-preview" style="display: none;">
            <br>
            <button onclick="analyzeImage()" id="analyzeBtn" disabled>AI 분석 실행</button>
            <div id="analysisResult" class="result-box"></div>
        </div>

        <!-- 포인트 히스토리 확인 -->
        <div class="test-section">
            <h2>💰 포인트 히스토리 확인</h2>
            <button onclick="checkPointHistory()">포인트 히스토리 조회</button>
            <button onclick="checkUserPoints()">사용자 포인트 확인</button>
            <div id="pointResult" class="result-box"></div>
        </div>

        <!-- 이미지 정보 확인 -->
        <div class="test-section">
            <h2>🖼️ 이미지 정보 확인</h2>
            <button onclick="checkImageInfo()">이미지 정보 조회</button>
            <div id="imageResult" class="result-box"></div>
        </div>

        <!-- 뱃지 정보 확인 -->
        <div class="test-section">
            <h2>🏆 뱃지 정보 확인</h2>
            <button onclick="checkBadges()">전체 뱃지 조회</button>
            <button onclick="checkUserBadges()">사용자 뱃지 조회</button>
            <div id="badgeResult" class="result-box"></div>
        </div>

        <!-- 통합 테스트 -->
        <div class="test-section">
            <h2>🎯 통합 테스트</h2>
            <button onclick="runFullTest()" style="background: #28a745;">전체 플로우 테스트</button>
            <div id="fullTestResult" class="result-box"></div>
        </div>

        <!-- 실시간 상태 -->
        <div class="test-section">
            <h2>📊 실시간 상태</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="currentPoints">0</div>
                    <div class="stat-label">현재 포인트</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalHistory">0</div>
                    <div class="stat-label">총 히스토리</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalBadges">0</div>
                    <div class="stat-label">획득 뱃지</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="aiAnalysis">0</div>
                    <div class="stat-label">AI 분석 횟수</div>
                </div>
            </div>
        </div>

        <!-- 상품교환 시스템 -->
        <div class="test-section">
            <h2>🛍️ 상품교환 시스템</h2>
            <div style="margin-bottom: 20px;">
                <button onclick="loadProducts()" class="btn-primary">📋 상품 목록 조회</button>
                <button onclick="checkExchangeHistory()" class="btn-info">📜 교환 내역 조회</button>
                <button onclick="showExchangeForm()" class="btn-success">🛒 상품 교환하기</button>
            </div>
            <div id="productResult" class="result-box"></div>
        </div>

        <!-- 랭킹 시스템 -->
        <div class="test-section">
            <h2>🏆 랭킹 시스템</h2>
            <div style="margin-bottom: 20px;">
                <button onclick="checkIndividualRanking()" class="btn-primary">👤 개인 랭킹 (Top 30)</button>
                <button onclick="checkCollegeRanking()" class="btn-info">🏫 단과대 랭킹 (Top 30)</button>
                <button onclick="checkCampusRanking()" class="btn-warning">🌍 캠퍼스 랭킹 (Top 30)</button>
                <button onclick="checkUserRanking()" class="btn-success">🔍 내 랭킹 확인</button>
            </div>
            <div id="rankingResult" class="result-box"></div>
        </div>

        <!-- 레벨 시스템 -->
        <div class="test-section">
            <h2>⭐ 레벨 시스템</h2>
            <div style="margin-bottom: 20px;">
                <button onclick="checkUserLevel()" class="btn-primary">👤 내 레벨 정보</button>
                <button onclick="checkLevelRequirements()" class="btn-info">📊 레벨업 조건</button>
                <button onclick="simulateLevelUp()" class="btn-warning">🚀 레벨업 시뮬레이션</button>
            </div>
            <div id="levelResult" class="result-box"></div>
        </div>

        <!-- 뱃지 관리 -->
        <div class="test-section">
            <h2>🎖️ 뱃지 관리</h2>
            <div style="margin-bottom: 20px;">
                <button onclick="initializeBadges()" class="btn-warning">🔄 기본 뱃지 초기화</button>
                <button onclick="checkAllBadgeConditions()" class="btn-info">🔍 모든 뱃지 조건 체크</button>
                <button onclick="checkBadges()" class="btn-primary">📋 전체 뱃지 조회</button>
                <button onclick="checkUserBadges()" class="btn-success">👤 사용자 뱃지 조회</button>
            </div>
            <div id="badgeResult" class="result-box"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://43.203.226.243:8080';
        let currentUserId = 1;
        let currentImageId = null;

        // 사용자 정보 로드
        async function loadUserData() {
            const userId = document.getElementById('userId').value;
            currentUserId = userId;
            
            try {
                const response = await fetch(`${BASE_URL}/api/users/${userId}`, {
                    mode: 'cors',
                    credentials: 'include',
                    referrerPolicy: 'no-referrer-when-downgrade'
                });
                const data = await response.json();
                
                if (response.ok) {
                    const user = data.data;
                    document.getElementById('userInfo').innerHTML = `
                        <h3>✅ 사용자 정보 로드 성공</h3>
                        <p><strong>사용자 ID:</strong> ${user.id}</p>
                        <p><strong>사용자명:</strong> ${user.username || 'N/A'}</p>
                        <p><strong>실명:</strong> ${user.name || 'N/A'}</p>
                        <p><strong>닉네임:</strong> ${user.nickname || 'N/A'}</p>
                        <p><strong>이메일:</strong> ${user.email || 'N/A'}</p>
                        <p><strong>학교:</strong> ${user.school || 'N/A'}</p>
                        <p><strong>단과대:</strong> ${user.college || 'N/A'}</p>
                        <p><strong>캠퍼스:</strong> ${user.campus || 'N/A'}</p>
                        <p><strong>현재 포인트:</strong> ${user.pointsTotal?.toLocaleString() || 'N/A'}P</p>
                        <p><strong>레벨:</strong> ${user.level || 'N/A'}</p>
                        <p><strong>가입일:</strong> ${user.createdAt ? new Date(user.createdAt).toLocaleDateString('ko-KR') : 'N/A'}</p>
                    `;
                    
                    // 실시간 상태 업데이트
                    updateStats();
                } else {
                    document.getElementById('userInfo').innerHTML = `<p class="error">❌ 사용자 정보 로드 실패: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('userInfo').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 이미지 미리보기
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.getElementById('analyzeBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        // AI 이미지 분석
        async function analyzeImage() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('이미지를 선택해주세요.');
                return;
            }

            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').textContent = '분석 중...';
            
            try {
                // AI 분석 (ChatGPT API 호출)
                const formData = new FormData();
                formData.append('image', file);
                formData.append('userId', currentUserId);
                
                const analysisResponse = await fetch(`${BASE_URL}/api/ai/analyze`, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                    credentials: 'include',
                    referrerPolicy: 'no-referrer-when-downgrade'
                });
                
                if (!analysisResponse.ok) {
                    throw new Error('AI 분석 실패');
                }
                
                const analysisData = await analysisResponse.json();
                
                // 3. 결과 표시
                const result = analysisData.data;
                document.getElementById('analysisResult').innerHTML = `
                    <h3>✅ AI 분석 완료!</h3>
                    <p><strong>분류 결과:</strong> ${result.classification || 'N/A'}</p>
                    <p><strong>획득 포인트:</strong> ${result.pointsEarned || 'N/A'}P</p>
                    <p><strong>설명:</strong> ${result.reason || 'N/A'}</p>
                    <p><strong>AI 응답:</strong> ${result.aiResponse || 'N/A'}</p>
                `;
                
                // 4. 상태 업데이트
                setTimeout(updateStats, 1000);
                
            } catch (error) {
                document.getElementById('analysisResult').innerHTML = `<p class="error">❌ AI 분석 실패: ${error.message}</p>`;
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'AI 분석 실행';
            }
        }

        // 포인트 히스토리 확인
        async function checkPointHistory() {
            try {
                const response = await fetch(`${BASE_URL}/api/points/user/${currentUserId}/type/all`);
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    const historyHtml = data.map(item => {
                        const typeLabel = getTypeLabel(item.type);
                        const pointsDisplay = item.points > 0 ? `+${item.points}` : `${item.points}`;
                        
                        return `
                            <div style="border-bottom: 1px solid #eee; padding: 15px 0; background: #f8f9fa; margin: 10px 0; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="font-weight: bold; color: #495057;">ID: ${item.id}</span>
                                    <span style="font-weight: bold; color: #6c757d;">${typeLabel}</span>
                                    <span style="font-weight: bold; color: ${item.points > 0 ? '#28a745' : '#dc3545'}; font-size: 1.1em;">${pointsDisplay}P</span>
                                </div>
                                <p style="margin: 5px 0;"><strong>설명:</strong> ${item.description || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>날짜:</strong> ${new Date(item.createdAt).toLocaleString('ko-KR')}</p>
                                ${item.image ? `
                                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                        <p style="margin: 5px 0;"><strong>📷 이미지 정보:</strong></p>
                                        <p style="margin: 5px 0;">파일명: ${item.image.filename}</p>
                                        <p style="margin: 5px 0;">크기: ${item.image.size} bytes</p>
                                        <p style="margin: 5px 0;">타입: ${item.image.contentType}</p>
                                        <img src="${BASE_URL}${item.image.url}" alt="${item.image.filename}" style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px; margin-top: 10px; display: block;">
                                        <a href="${BASE_URL}${item.image.url}" target="_blank" style="color: #007bff; text-decoration: none; font-size: 12px; margin-top: 5px; display: inline-block;">🔗 새 창에서 보기</a>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('pointResult').innerHTML = `
                        <h3>✅ 포인트 히스토리 조회 성공 (${data.length}개)</h3>
                        <div style="margin-top: 15px;">
                            ${historyHtml}
                        </div>
                    `;
                } else {
                    document.getElementById('pointResult').innerHTML = `<p class="error">❌ 포인트 히스토리 조회 실패</p>`;
                }
            } catch (error) {
                document.getElementById('pointResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 타입별 한글 라벨 변환
        function getTypeLabel(type) {
            switch (type) {
                case 'AI_ANALYSIS': return '🤖 AI 분석';
                case 'MANUAL_ADD': return '✏️ 수동 추가';
                case 'BADGE_EARNED': return '🏆 뱃지 획득';
                case 'PRODUCT_PURCHASE': return '🛒 상품 구매';
                case 'POINT_DEDUCTION': return '➖ 포인트 차감';
                case 'EARNED': return '➕ 포인트 적립';
                case 'SPENT': return '➖ 포인트 사용';
                default: return type || '기타';
            }
        }

        // 사용자 포인트 확인
        async function checkUserPoints() {
            try {
                const response = await fetch(`${BASE_URL}/api/users/${currentUserId}`);
                const data = await response.json();
                
                if (response.ok) {
                    const user = data.data;
                    document.getElementById('pointResult').innerHTML = `
                        <h3>✅ 사용자 포인트 확인</h3>
                        <p><strong>현재 총 포인트:</strong> ${user.pointsTotal?.toLocaleString() || 'N/A'}P</p>
                        <p><strong>레벨:</strong> ${user.level || 'N/A'}</p>
                    `;
                } else {
                    document.getElementById('pointResult').innerHTML = `<p class="error">❌ 사용자 포인트 확인 실패</p>`;
                }
            } catch (error) {
                document.getElementById('pointResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 이미지 정보 확인
        async function checkImageInfo() {
            if (!currentImageId) {
                document.getElementById('imageResult').innerHTML = '<p class="info">ℹ️ 먼저 AI 분석을 실행해주세요.</p>';
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/api/points/images/${currentImageId}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('imageResult').innerHTML = `
                        <h3>✅ 이미지 정보 조회 성공</h3>
                        <p><strong>이미지 ID:</strong> ${data.data.id}</p>
                        <p><strong>파일명:</strong> ${data.data.fileName}</p>
                        <p><strong>크기:</strong> ${data.data.fileSize} bytes</p>
                        <p><strong>타입:</strong> ${data.data.contentType}</p>
                        <p><strong>업로드 시간:</strong> ${new Date(data.data.createdAt).toLocaleString('ko-KR')}</p>
                        <p><strong>다운로드 URL:</strong> <a href="${BASE_URL}/api/points/images/file/${data.data.id}" target="_blank">이미지 다운로드</a></p>
                    `;
                } else {
                    document.getElementById('imageResult').innerHTML = `<p class="error">❌ 이미지 정보 조회 실패: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('imageResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 전체 뱃지 조회
        async function checkBadges() {
            try {
                const response = await fetch(`${BASE_URL}/api/badges`);
                const data = await response.json();
                
                if (response.ok) {
                    const badgesHtml = data.data.map(badge => `
                        <div class="badge" style="margin: 5px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; min-width: 250px;">
                            <h4 style="margin: 0 0 10px 0; color: #495057;">${badge.name}</h4>
                            <p style="margin: 5px 0;"><strong>설명:</strong> ${badge.description}</p>
                            <p style="margin: 5px 0;"><strong>보상 포인트:</strong> <span style="color: #28a745; font-weight: bold;">+${badge.pointsReward}P</span></p>
                            <p style="margin: 5px 0;"><strong>카테고리:</strong> ${badge.category}</p>
                            <p style="margin: 5px 0;"><strong>획득 조건:</strong></p>
                            <p style="margin: 5px 0; padding: 8px; background: #e9ecef; border-radius: 4px; font-size: 12px;">${badge.conditionDescription}</p>
                            <p style="margin: 5px 0; font-size: 11px; color: #6c757d;">조건: ${badge.conditionType} = ${badge.conditionValue}</p>
                        </div>
                    `).join('');
                    
                    document.getElementById('badgeResult').innerHTML = `
                        <h3>✅ 전체 뱃지 조회 성공 (${data.data.length}개)</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
                            ${badgesHtml}
                        </div>
                    `;
                } else {
                    document.getElementById('badgeResult').innerHTML = `<p class="error">❌ 뱃지 조회 실패: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('badgeResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 사용자 뱃지 조회
        async function checkUserBadges() {
            try {
                const response = await fetch(`${BASE_URL}/api/badges/user/${currentUserId}`);
                const data = await response.json();
                
                if (response.ok) {
                    const userBadges = data.data || [];
                    const earnedBadges = userBadges.filter(badge => badge.earned);
                    
                    const badgesHtml = userBadges.map(badge => `
                        <div class="badge ${badge.earned ? 'earned' : ''}" style="margin: 5px; padding: 10px; border-radius: 8px;">
                            <h4>${badge.name}</h4>
                            <p><strong>상태:</strong> ${badge.earned ? '획득됨' : '미획득'}</p>
                            ${badge.earnedAt ? `<p><strong>획득일:</strong> ${new Date(badge.earnedAt).toLocaleDateString('ko-KR')}</p>` : ''}
                        </div>
                    `).join('');
                    
                    document.getElementById('badgeResult').innerHTML = `
                        <h3>✅ 사용자 뱃지 조회 성공</h3>
                        <p><strong>획득한 뱃지:</strong> ${earnedBadges.length}개</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${badgesHtml}
                        </div>
                    `;
                } else {
                    document.getElementById('badgeResult').innerHTML = `<p class="error">❌ 사용자 뱃지 조회 실패: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('badgeResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 전체 플로우 테스트
        async function runFullTest() {
            document.getElementById('fullTestResult').innerHTML = '<p class="info">🔄 전체 플로우 테스트 시작...</p>';
            
            try {
                // 1. 사용자 정보 로드
                document.getElementById('fullTestResult').innerHTML += '<p>1️⃣ 사용자 정보 로드 중...</p>';
                await loadUserData();
                
                // 2. 뱃지 초기화 (필요한 경우)
                document.getElementById('fullTestResult').innerHTML += '<p>2️⃣ 뱃지 초기화 확인 중...</p>';
                try {
                    const badgeResponse = await fetch(`${BASE_URL}/api/badges`);
                    if (badgeResponse.ok) {
                        const badgeData = await badgeResponse.json();
                        if (badgeData.data.length === 0) {
                            document.getElementById('fullTestResult').innerHTML += '<p>⚠️ 뱃지가 없습니다. 기본 뱃지를 초기화합니다...</p>';
                            await initializeBadges();
                        } else {
                            document.getElementById('fullTestResult').innerHTML += `<p>✅ 뱃지 ${badgeData.data.length}개가 이미 존재합니다.</p>`;
                        }
                    }
                } catch (error) {
                    document.getElementById('fullTestResult').innerHTML += '<p>⚠️ 뱃지 확인 중 오류 발생</p>';
                }
                
                // 3. 포인트 히스토리 확인
                document.getElementById('fullTestResult').innerHTML += '<p>3️⃣ 포인트 히스토리 확인 중...</p>';
                await checkPointHistory();
                
                // 4. 뱃지 정보 확인
                document.getElementById('fullTestResult').innerHTML += '<p>4️⃣ 뱃지 정보 확인 중...</p>';
                await checkBadges();
                await checkUserBadges();
                
                // 5. 상태 업데이트
                document.getElementById('fullTestResult').innerHTML += '<p>5️⃣ 상태 업데이트 중...</p>';
                await updateStats();
                
                document.getElementById('fullTestResult').innerHTML += '<p class="success">✅ 전체 플로우 테스트 완료!</p>';
                document.getElementById('fullTestResult').innerHTML += '<p>이제 AI 이미지 분석을 실행해보세요!</p>';
                
            } catch (error) {
                document.getElementById('fullTestResult').innerHTML += `<p class="error">❌ 테스트 실패: ${error.message}</p>`;
            }
        }

        // 뱃지 초기화 (모든 사용자의 뱃지를 미획득 상태로 변경)
        async function initializeBadges() {
            if (!confirm('기본 뱃지들을 초기화하시겠습니까? 이 작업은 기존 뱃지 데이터를 덮어씁니다.')) {
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/badges/initialize`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('✅ 기본 뱃지가 성공적으로 초기화되었습니다!');
                    // 초기화 후 다시 뱃지 목록 확인
                    await checkBadges();
                    await checkUserBadges();
                    updateStats();
                } else {
                    const errorData = await response.json();
                    alert(`❌ 뱃지 초기화 실패: ${errorData.error}`);
                }
            } catch (error) {
                alert(`❌ 뱃지 초기화 중 오류 발생: ${error.message}`);
            }
        }

        // 모든 뱃지 조건 체크 (현재 사용자의 모든 뱃지 조건을 확인)
        async function checkAllBadgeConditions() {
            try {
                const response = await fetch(`${BASE_URL}/api/badges/check-all-conditions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    alert('✅ 모든 뱃지 조건을 확인했습니다! 조건에 맞는 뱃지가 자동으로 지급되었을 수 있습니다.');
                    // 상태 업데이트
                    await checkUserBadges();
                    updateStats();
                } else {
                    alert(`❌ 뱃지 조건 체크 실패: ${data.error}`);
                }
            } catch (error) {
                alert(`❌ 뱃지 조건 체크 중 오류 발생: ${error.message}`);
            }
        }

        // 상품 목록 조회
        async function loadProducts() {
            try {
                const response = await fetch(`${BASE_URL}/api/products`);
                const data = await response.json();
                
                if (response.ok && Array.isArray(data)) {
                    const productsHtml = data.map(product => `
                        <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; background: white;">
                            <h4 style="margin: 0 0 10px 0; color: #495057;">${product.name}</h4>
                            <p style="margin: 5px 0;"><strong>설명:</strong> ${product.description}</p>
                            <p style="margin: 5px 0;"><strong>필요 포인트:</strong> <span style="color: #dc3545; font-weight: bold;">${product.pointsRequired}P</span></p>
                            <p style="margin: 5px 0;"><strong>재고:</strong> ${product.stockQuantity || '무제한'}</p>
                            <p style="margin: 5px 0;"><strong>카테고리:</strong> ${product.category}</p>
                            <button onclick="exchangeProduct(${product.id}, '${product.name}', ${product.pointsRequired})" class="btn-success" style="margin-top: 10px;">
                                🛒 교환하기 (${product.pointsRequired}P)
                            </button>
                        </div>
                    `).join('');
                    
                    document.getElementById('productResult').innerHTML = `
                        <h3>✅ 상품 목록 조회 성공 (${data.length}개)</h3>
                        <div style="margin-top: 15px;">
                            ${productsHtml}
                        </div>
                    `;
                } else {
                    document.getElementById('productResult').innerHTML = `<p class="error">❌ 상품 조회 실패: ${data.error || '알 수 없는 오류'}</p>`;
                }
            } catch (error) {
                document.getElementById('productResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 상품 교환
        async function exchangeProduct(productId, productName, requiredPoints) {
            if (!confirm(`"${productName}"을(를) ${requiredPoints}P로 교환하시겠습니까?`)) {
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/exchanges`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        productId: productId,
                        points: requiredPoints
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`✅ "${productName}" 교환 완료! ${requiredPoints}P가 차감되었습니다.`);
                    // 교환 후 포인트와 통계 업데이트
                    await updateStats();
                    await loadUserData();
                    document.getElementById('productResult').innerHTML = `
                        <h3>✅ 상품 교환 성공!</h3>
                        <p><strong>상품:</strong> ${productName}</p>
                        <p><strong>차감된 포인트:</strong> ${requiredPoints}P</p>
                        <p><strong>교환 시간:</strong> ${new Date().toLocaleString('ko-KR')}</p>
                    `;
                } else {
                    alert(`❌ 교환 실패: ${data.error || '알 수 없는 오류'}`);
                }
            } catch (error) {
                alert(`❌ 교환 중 오류 발생: ${error.message}`);
            }
        }

        // 교환 내역 조회
        async function checkExchangeHistory() {
            try {
                const response = await fetch(`${BASE_URL}/api/exchanges/user/${currentUserId}`);
                const data = await response.json();
                
                if (response.ok && data.data) {
                    const exchangesHtml = data.data.map(exchange => `
                        <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: bold; color: #495057;">${exchange.productName || '상품'}</span>
                                <span style="font-weight: bold; color: #dc3545;">-${exchange.pointsUsed}P</span>
                            </div>
                            <p style="margin: 5px 0;"><strong>교환 시간:</strong> ${new Date(exchange.createdAt).toLocaleString('ko-KR')}</p>
                            <p style="margin: 5px 0;"><strong>상태:</strong> ${exchange.status || '완료'}</p>
                        </div>
                    `).join('');
                    
                    document.getElementById('productResult').innerHTML = `
                        <h3>✅ 교환 내역 조회 성공 (${data.data.length}개)</h3>
                        <div style="margin-top: 15px;">
                            ${exchangesHtml}
                        </div>
                    `;
                } else {
                    document.getElementById('productResult').innerHTML = `<p class="error">❌ 교환 내역 조회 실패: ${data.error || '내역이 없습니다'}</p>`;
                }
            } catch (error) {
                document.getElementById('productResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 상품 교환 폼 표시
        function showExchangeForm() {
            document.getElementById('productResult').innerHTML = `
                <h3>🛒 상품 교환</h3>
                <p>상품 목록을 먼저 조회한 후 원하는 상품의 "교환하기" 버튼을 클릭하세요.</p>
                <button onclick="loadProducts()" class="btn-primary">📋 상품 목록 조회</button>
            `;
        }

        // 개인 랭킹 조회 (Top 30)
        async function checkIndividualRanking() {
            try {
                const response = await fetch(`${BASE_URL}/api/rankings/individuals?limit=30`);
                const data = await response.json();
                
                if (response.ok && data.data) {
                    const rankingHtml = data.data.map((user, index) => `
                        <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: bold; color: #007bff; font-size: 1.2em;">🏆 ${index + 1}위</span>
                                <span style="font-weight: bold; color: #28a745; font-size: 1.1em;">${user.points}P</span>
                            </div>
                            <p style="margin: 5px 0;"><strong>사용자:</strong> ${user.name || user.username}</p>
                            <p style="margin: 5px 0;"><strong>단과대:</strong> ${user.college || 'N/A'}</p>
                            <p style="margin: 5px 0;"><strong>캠퍼스:</strong> ${user.campus || 'N/A'}</p>
                        </div>
                    `).join('');
                    
                    document.getElementById('rankingResult').innerHTML = `
                        <h3>✅ 개인 랭킹 (Top 30)</h3>
                        <div style="margin-top: 15px;">
                            ${rankingHtml}
                        </div>
                    `;
                } else {
                    document.getElementById('rankingResult').innerHTML = `<p class="error">❌ 개인 랭킹 조회 실패: ${data.error || '랭킹 데이터가 없습니다'}</p>`;
                }
            } catch (error) {
                document.getElementById('rankingResult').innerHTML = `
                    <h3>⚠️ 랭킹 시스템 점검 중</h3>
                    <p class="error">백엔드 랭킹 서비스에 일시적인 문제가 있습니다.</p>
                    <p><strong>오류 내용:</strong> ${error.message}</p>
                    <p><strong>해결 방법:</strong> 잠시 후 다시 시도해주세요.</p>
                `;
            }
        }

        // 단과대 랭킹 조회 (Top 30)
        async function checkCollegeRanking() {
            try {
                const response = await fetch(`${BASE_URL}/api/rankings/colleges?limit=30`);
                const data = await response.json();
                
                if (response.ok && data.data) {
                    const rankingHtml = data.data.map((college, index) => `
                        <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: bold; color: #007bff; font-size: 1.2em;">🏆 ${index + 1}위</span>
                                <span style="font-weight: bold; color: #28a745; font-size: 1.1em;">${college.score}P</span>
                            </div>
                            <p style="margin: 5px 0;"><strong>단과대:</strong> ${college.college}</p>
                            <p style="margin: 5px 0;"><strong>멤버 수:</strong> ${college.members}명</p>
                        </div>
                    `).join('');
                    
                    document.getElementById('rankingResult').innerHTML = `
                        <h3>✅ 단과대 랭킹 (Top 30)</h3>
                        <div style="margin-top: 15px;">
                            ${rankingHtml}
                        </div>
                    `;
                } else {
                    document.getElementById('rankingResult').innerHTML = `<p class="error">❌ 단과대 랭킹 조회 실패: ${data.error || '랭킹 데이터가 없습니다'}</p>`;
                }
            } catch (error) {
                document.getElementById('rankingResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 캠퍼스 랭킹 조회 (Top 30)
        async function checkCampusRanking() {
            try {
                const response = await fetch(`${BASE_URL}/api/rankings/campuses?limit=30`);
                const data = await response.json();
                
                if (response.ok && data.data) {
                    const rankingHtml = data.data.map((campus, index) => `
                        <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: bold; color: #007bff; font-size: 1.2em;">🏆 ${index + 1}위</span>
                                <span style="font-weight: bold; color: #28a745; font-size: 1.1em;">${campus.score}P</span>
                            </div>
                            <p style="margin: 5px 0;"><strong>캠퍼스:</strong> ${campus.campus}</p>
                            <p style="margin: 5px 0;"><strong>멤버 수:</strong> ${campus.members}명</p>
                        </div>
                    `).join('');
                    
                    document.getElementById('rankingResult').innerHTML = `
                        <h3>✅ 캠퍼스 랭킹 (Top 30)</h3>
                        <div style="margin-top: 15px;">
                            ${rankingHtml}
                        </div>
                    `;
                } else {
                    document.getElementById('rankingResult').innerHTML = `<p class="error">❌ 캠퍼스 랭킹 조회 실패: ${data.error || '랭킹 데이터가 없습니다'}</p>`;
                }
            } catch (error) {
                document.getElementById('rankingResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 내 랭킹 확인
        async function checkUserRanking() {
            try {
                // 개인 랭킹에서 내 순위 찾기
                const response = await fetch(`${BASE_URL}/api/rankings/individuals?limit=100`);
                const data = await response.json();
                
                if (response.ok && data.data) {
                    const myRanking = data.data.find(user => user.userId == currentUserId);
                    
                    if (myRanking) {
                        const rank = data.data.findIndex(user => user.userId == currentUserId) + 1;
                        document.getElementById('rankingResult').innerHTML = `
                            <h3>✅ 내 랭킹 정보</h3>
                            <div style="border: 1px solid #28a745; border-radius: 8px; padding: 20px; margin: 15px 0; background: #f8fff9;">
                                <h4 style="margin: 0 0 15px 0; color: #28a745;">🏆 ${rank}위</h4>
                                <p style="margin: 8px 0;"><strong>포인트:</strong> ${myRanking.points}P</p>
                                <p style="margin: 8px 0;"><strong>단과대:</strong> ${myRanking.college || 'N/A'}</p>
                                <p style="margin: 8px 0;"><strong>캠퍼스:</strong> ${myRanking.campus || 'N/A'}</p>
                            </div>
                        `;
                    } else {
                        document.getElementById('rankingResult').innerHTML = `
                            <h3>ℹ️ 내 랭킹 정보</h3>
                            <p>현재 Top 100에 포함되지 않았습니다.</p>
                            <p>더 많은 포인트를 모아서 랭킹에 도전해보세요!</p>
                        `;
                    }
                } else {
                    document.getElementById('rankingResult').innerHTML = `<p class="error">❌ 랭킹 조회 실패: ${data.error || '랭킹 데이터가 없습니다'}</p>`;
                }
            } catch (error) {
                document.getElementById('rankingResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 내 레벨 정보 확인
        async function checkUserLevel() {
            try {
                const response = await fetch(`${BASE_URL}/api/users/${currentUserId}`);
                const data = await response.json();
                
                if (response.ok) {
                    const user = data.data;
                    const currentLevel = user.level || 1;
                    const currentPoints = user.pointsTotal || 0;
                    
                    // 레벨별 필요 포인트 계산 (예시)
                    const nextLevelPoints = Math.pow(currentLevel + 1, 2) * 100;
                    const progress = Math.min((currentPoints / nextLevelPoints) * 100, 100);
                    
                    document.getElementById('levelResult').innerHTML = `
                        <h3>✅ 내 레벨 정보</h3>
                        <div style="border: 1px solid #007bff; border-radius: 8px; padding: 20px; margin: 15px 0; background: #f8fbff;">
                            <h4 style="margin: 0 0 15px 0; color: #007bff;">⭐ Level ${currentLevel}</h4>
                            <p style="margin: 8px 0;"><strong>현재 포인트:</strong> ${currentPoints.toLocaleString()}P</p>
                            <p style="margin: 8px 0;"><strong>다음 레벨까지:</strong> ${nextLevelPoints.toLocaleString()}P</p>
                            <div style="margin: 15px 0;">
                                <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                                    <div style="background: #007bff; height: 100%; width: ${progress}%; transition: width 0.3s ease;"></div>
                                </div>
                                <p style="margin: 5px 0; font-size: 12px; color: #6c757d;">진행률: ${progress.toFixed(1)}%</p>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('levelResult').innerHTML = `<p class="error">❌ 사용자 정보 조회 실패: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('levelResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 레벨업 조건 확인
        function checkLevelRequirements() {
            document.getElementById('levelResult').innerHTML = `
                <h3>📊 레벨업 조건</h3>
                <div style="margin-top: 15px;">
                    <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; background: white;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Level 1 → 2</h4>
                        <p style="margin: 5px 0;"><strong>필요 포인트:</strong> 400P</p>
                        <p style="margin: 5px 0;"><strong>획득 방법:</strong> AI 이미지 분석, 활동 참여</p>
                    </div>
                    <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; background: white;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Level 2 → 3</h4>
                        <p style="margin: 5px 0;"><strong>필요 포인트:</strong> 900P</p>
                        <p style="margin: 5px 0;"><strong>획득 방법:</strong> 지속적인 활동 참여</p>
                    </div>
                    <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; background: white;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Level 3 → 4</h4>
                        <p style="margin: 5px 0;"><strong>필요 포인트:</strong> 1,600P</p>
                        <p style="margin: 5px 0;"><strong>획득 방법:</strong> 뱃지 획득, 상품 교환</p>
                    </div>
                </div>
            `;
        }

        // 레벨업 시뮬레이션
        async function simulateLevelUp() {
            try {
                const response = await fetch(`${BASE_URL}/api/users/${currentUserId}`);
                const data = await response.json();
                
                if (response.ok) {
                    const user = data.data;
                    const currentLevel = user.level || 1;
                    const currentPoints = user.pointsTotal || 0;
                    
                    // 레벨업 조건 체크
                    const nextLevelPoints = Math.pow(currentLevel + 1, 2) * 100;
                    
                    if (currentPoints >= nextLevelPoints) {
                        document.getElementById('levelResult').innerHTML = `
                            <h3>🚀 레벨업 가능!</h3>
                            <div style="border: 1px solid #28a745; border-radius: 8px; padding: 20px; margin: 15px 0; background: #f8fff9;">
                                <h4 style="margin: 0 0 15px 0; color: #28a745;">🎉 Level ${currentLevel} → ${currentLevel + 1}</h4>
                                <p style="margin: 8px 0;"><strong>현재 포인트:</strong> ${currentPoints.toLocaleString()}P</p>
                                <p style="margin: 8px 0;"><strong>필요 포인트:</strong> ${nextLevelPoints.toLocaleString()}P</p>
                                <p style="margin: 8px 0; color: #28a745;"><strong>✅ 레벨업 조건 충족!</strong></p>
                                <p style="margin: 8px 0; font-size: 12px; color: #6c757d;">레벨업은 자동으로 처리됩니다.</p>
                            </div>
                        `;
                    } else {
                        const remaining = nextLevelPoints - currentPoints;
                        document.getElementById('levelResult').innerHTML = `
                            <h3>📊 레벨업 현황</h3>
                            <div style="border: 1px solid #ffc107; border-radius: 8px; padding: 20px; margin: 15px 0; background: #fffbf0;">
                                <h4 style="margin: 0 0 15px 0; color: #ffc107;">⏳ Level ${currentLevel} 유지</h4>
                                <p style="margin: 8px 0;"><strong>현재 포인트:</strong> ${currentPoints.toLocaleString()}P</p>
                                <p style="margin: 8px 0;"><strong>필요 포인트:</strong> ${nextLevelPoints.toLocaleString()}P</p>
                                <p style="margin: 8px 0; color: #dc3545;"><strong>❌ 레벨업까지 ${remaining.toLocaleString()}P 더 필요</strong></p>
                                <p style="margin: 8px 0; font-size: 12px; color: #6c757d;">AI 이미지 분석을 통해 포인트를 모아보세요!</p>
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('levelResult').innerHTML = `<p class="error">❌ 사용자 정보 조회 실패: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('levelResult').innerHTML = `<p class="error">❌ 오류: ${error.message}</p>`;
            }
        }

        // 통계 업데이트
        async function updateStats() {
            try {
                // 사용자 포인트
                const userResponse = await fetch(`${BASE_URL}/api/users/${currentUserId}`);
                if (userResponse.ok) {
                    const user = (await userResponse.json()).data;
                    document.getElementById('currentPoints').textContent = user.pointsTotal?.toLocaleString() || '0';
                }
                
                // 포인트 히스토리
                const historyResponse = await fetch(`${BASE_URL}/api/points/user/${currentUserId}/type/all`);
                if (Array.isArray(historyResponse.data)) {
                    const history = await historyResponse.json();
                    document.getElementById('totalHistory').textContent = history.length;
                    document.getElementById('aiAnalysis').textContent = history.filter(h => h.type === 'AI_ANALYSIS').length;
                }
                
                // 뱃지
                const badgeResponse = await fetch(`${BASE_URL}/api/badges/user/${currentUserId}`);
                if (badgeResponse.ok) {
                    const badges = (await badgeResponse.json()).data || [];
                    document.getElementById('totalBadges').textContent = badges.filter(b => b.earned).length;
                }
                
            } catch (error) {
                console.log('통계 업데이트 실패:', error);
            }
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            loadUserData();
        };
    </script>
</body>
</html>